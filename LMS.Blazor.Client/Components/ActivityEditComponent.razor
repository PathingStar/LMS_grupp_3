@using LMS.Blazor.Client.Services
@using LMS.Shared.DTOs.EntityDto

<div class="container mt-4">
    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger" role="alert">
            <p>@errorMessage</p>
        </div>
    }

    @if (ActivityUpdDto == null)
    { }
    else
    {
        <EditForm class="form" Model="@ActivityUpdDto" OnValidSubmit="@HandleValidSubmit" FormName="EditActivity">
            <DataAnnotationsValidator />
            <ValidationSummary />
            <div>
                <label for="name" class="form-label">Name</label>
                <InputText class="form-control" @bind-Value="@ActivityUpdDto.Name" id="name" placeholder="Name" />
                <ValidationMessage For="@(() => ActivityUpdDto.Name)" />
            </div>
            <div>
                <label for="description" class="form-label">Description</label>
                <InputText class="form-control" @bind-Value="@ActivityUpdDto.Description" id="description" placeholder="Description" />
                <ValidationMessage For="@(() => ActivityUpdDto.Description)" />
            </div>
            <div>
                <label for="activityDate" class="form-label">Activity Date</label>
                <InputDate class="form-control" @bind-Value="ActivityDate" id="activityDate" />
            </div>
            <div class="mb-3">
                <label>Start Time</label>
                <InputText type="time" @bind-Value="StartTimeString" class="form-control" placeholder="HH:mm" />
            </div>

            <div class="mb-3">
                <label>End Time</label>
                <InputText type="time" @bind-Value="EndTimeString" class="form-control" placeholder="HH:mm" />
            </div>
            <div>
                <label for="category" class="form-label">Category</label>
                <InputSelect id="category" class="form-select" @bind-Value="@ActivityUpdDto.ActivityTypeId">
                    <option value="">-- Select Category --</option>
                    @foreach (var type in Types)
                    {
                        <option value="@type.Id">@type.Name</option>
                    }
                </InputSelect>
                <ValidationMessage For="@(() => ActivityUpdDto.ActivityTypeId)" />
            </div>
            
                <button type="cancel" class="btn btn-primary" @onclick="StopEditing">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
            

        </EditForm>
    }

</div>

@code {

    [Inject]
    private IApiService myApi { get; set; } = default!;

    [Parameter]
    public ModuleActivityDto Activity { get; set; }

    [Parameter]
    public Guid currentModuleId { get; set; }

    [Parameter]
    public EventCallback<ModuleActivityDto> OnEditDone { get; set; }

    public ModuleActivityUpdateDto ActivityUpdDto { get; set; } = new ModuleActivityUpdateDto();
    public List<ActivityTypeDto> Types { get; set; } = new List<ActivityTypeDto>();
    private string? errorMessage;

    private DateTime ActivityDate
    {
        get => _activityDate;
        set
        {
            _activityDate = value;
            // preserve times
            var startTime = ActivityUpdDto.StartDate.TimeOfDay;
            var endTime = ActivityUpdDto.EndDate.TimeOfDay;
            ActivityUpdDto.StartDate = value.Date + startTime;
            ActivityUpdDto.EndDate = value.Date + endTime;
        }
    }
    private DateTime _activityDate;

    public string StartTimeString
    {
        get => ActivityUpdDto.StartDate.ToString("HH:mm");
        set
        {
            if (TimeSpan.TryParse(value, out var ts))
            {
                ActivityUpdDto.StartDate = ActivityDate.Date + ts;
            }
        }
    }

    public string EndTimeString
    {
        get => ActivityUpdDto.EndDate.ToString("HH:mm");
        set
        {
            if (TimeSpan.TryParse(value, out var ts))
            {
                ActivityUpdDto.EndDate = ActivityDate.Date + ts;
            }
        }
    }

    protected override async Task OnInitializedAsync()
    {

        ActivityDate = Activity.StartDate.Date;
        ActivityUpdDto = new ModuleActivityUpdateDto
        {
            Id = Activity.Id,
            Name = Activity.Name,
            Description = Activity.Description,
            StartDate = Activity.StartDate,
            EndDate = Activity.EndDate,
            ActivityTypeId = Activity.ActivityTypeId,
            //			Type = Activity.Type,
            ModuleId = currentModuleId

        };
        try
        {
            Types = (await myApi.CallApiGetAsync<List<ActivityTypeDto>>("activity-types"));
        }
        catch (HttpRequestException ex)
        {
            errorMessage = $"API Error: {ex.StatusCode} - {ex.Message}";
            Console.WriteLine("there was an API error: " + ex.Message);
        }
    }

    private async Task StopEditing()
    {
        await OnEditDone.InvokeAsync(Activity);
    }

    private async Task HandleValidSubmit()
    {
        try
        {
            Activity = await myApi.CallApiPutAsync<ModuleActivityUpdateDto, ModuleActivityDto>($"activities/{Activity.Id}", ActivityUpdDto);
            Console.WriteLine($"Course '{ActivityUpdDto.Name}' saved successfully!");
            StopEditing();
        }
        catch (System.ComponentModel.DataAnnotations.ValidationException apiEx)
        {
            errorMessage = $"API Error:  - {apiEx.Message}";
            Console.WriteLine("there was an API error: " + apiEx.Message);
        }

    }

}
