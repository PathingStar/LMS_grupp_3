@using System.Security.Claims
@using System.Text.Json
@using Domain.Models.Entities
@using LMS.Blazor.Client.Models
@using System.Text
@using Microsoft.AspNetCore.Identity
@inject IApiService ApiService

<h3>SubmissionAddComponent</h3>

<div class="border">
	<EditForm Model="@model" OnValidSubmit=HandleValidSubmit>
		<DataAnnotationsValidator />
		<ValidationSummary />
		<div class="form-group">
			<label for="document">Document</label>
			<InputFile id="document" class="form-control" OnChange="OnFileSelected" />
		</div>
		<div class="form-group">
			<label for="description">Document Description</label>
			<InputTextArea id="description" class="form-control" @bind-Value="model.DocumentDescription" />
		</div>
		<div class="mb-3">
			<label>Group Members</label>
			<select multiple class="form-select" @onchange="OnGroupMembersChanged">
				@foreach (var u in Users)
				{
					<option value="@u.Id" selected="@model.SubmitterIds.Contains(u.Id)">@u.Email</option>
				}
			</select>
			<small class="form-text text-muted">
				Hold Ctrl (Windows) or Cmd (Mac) to select multiple users.
			</small>
		</div>
		<div class="form-group">
			<label for="description">Comment</label>
			<InputTextArea id="description" class="form-control" @bind-Value="model.Comment" />
		</div>
		<button type="submit" class="btn btn-primary">Add Document</button>

		@if (uploadSuccess)
		{
			<p class="text-success">Submission uploaded!</p>
		}

	</EditForm>
</div>

@code 
{
	[CascadingParameter] private Task<AuthenticationState> AuthStateTask { get; set; }
	[Parameter]
	public Guid AssignmentId { get; set; }
	private string? UploaderId;
	private List<SubmissionCreateDto> MyDtoArr;
	private SubmissionCreateDto dto;
	private List<UserDto> Users = new();

	private Model model = new();
	private DocumentInfo documentInfo = new();
	private bool uploadSuccess = false;

	private class Model
	{
		public string? DocumentDescription { get; set; }
		public string? Comment { get; set; }
		public List<string> SubmitterIds { get; set; } = new();
	}

	
	private async Task HandleValidSubmit()
	{
		if (!model.SubmitterIds.Contains(UploaderId))
			model.SubmitterIds.Insert(0, UploaderId);
		
		var submissionJson = JsonSerializer.Serialize(new SubmissionCreateDto
		{
			AssignmentId = AssignmentId,
			SubmitterIds = model.SubmitterIds,
			Description = model.Comment
		});


		using var content = new MultipartFormDataContent();

		var fileContent = new ByteArrayContent(documentInfo.Content);
		fileContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue(documentInfo.ContentType ?? "application/octet-stream");
		content.Add(fileContent, "File", documentInfo.FileName);

		content.Add(new StringContent(submissionJson, Encoding.UTF8, "application/json"), "submission");

		var result = await ApiService.CallApiPostMultipartAsync<SubmissionDto>("submissions", content);
	}
	private async void OnFileSelected(InputFileChangeEventArgs e)
	{
		var file = e.File;

		// Read into byte[]
		using var stream = file.OpenReadStream(maxAllowedSize: 10_000_000);
		using var ms = new MemoryStream();
		await stream.CopyToAsync(ms);

		documentInfo.FileName = file.Name;
		documentInfo.ContentType = file.ContentType;
		documentInfo.Content = ms.ToArray();


		uploadSuccess = false;
	}

	private void OnGroupMembersChanged(ChangeEventArgs e)
	{
		var selectedOptions = e.Value as IEnumerable<string>;
		if (selectedOptions != null)
		{
			model.SubmitterIds = selectedOptions.ToList();
		}
	}
	
	protected override async Task OnInitializedAsync()
	{
		var authState = await AuthStateTask;
		var user = authState.User;
		if (user.Identity?.IsAuthenticated == true)
		{
			UploaderId = user.FindFirst(c => c.Type == ClaimTypes.NameIdentifier)?.Value;
			if (!string.IsNullOrEmpty(UploaderId) && !model.SubmitterIds.Contains(UploaderId))
			{
				model.SubmitterIds.Add(UploaderId);
			}
		}
		var courseIdAsString = user.FindFirst("CourseId")?.Value;
		Users = await ApiService.CallApiGetAsync<List<UserDto>>($"users/course/{courseIdAsString}") ?? new List<UserDto>();

	}
}
