@page "/schedule"
@using Radzen
@using Radzen.Blazor
@using LMS.Shared.DTOs.EntityDTO
@inject NavigationManager Navigation

<PageTitle>Schedule</PageTitle>

<h3>Course Schedule</h3>

<RadzenScheduler Data="@Events"
                 StartProperty="Start"
                 EndProperty="End"
                 TextProperty="Text"
                 View="Month"
                 TItem="ScheduleEvent">
</RadzenScheduler>

@code {
    [Inject]
    private IApiService myApi { get; set; } = default!;
    [Inject]
    private AuthenticationStateProvider Auth { get; set; } = default!;
    private string CourseId;

    // Event class for the scheduler
    public class ScheduleEvent
    {
        public DateTime Start { get; set; }
        public DateTime End { get; set; }
        public string Text { get; set; }
    }

    private List<ScheduleEvent> Events = new();
    private bool Loading = true;

    private ScheduleDto MySchedule = new();

    // This is just an example of loading your schedule — in real life you probably get it from your API
    private bool hasLoaded = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !hasLoaded)
        {
            hasLoaded = true;
            await OnInitializedAsync(); // Retry now that client is ready
            StateHasChanged();
        }
    }


    private async Task HandleTeacher()
    {
        var response = await myApi.CallApiGetAsync<IEnumerable<CourseDto>>("courses");
        Console.WriteLine($"Found {response?.Count()} courses.");
        CourseId = response?.ToList()[0].Id.ToString();
        Console.WriteLine($"Using CourseId: {CourseId}");
    }

    private void HandleStudent(System.Security.Claims.ClaimsPrincipal user)
    {
        CourseId = user.Claims.FirstOrDefault(c => c.Type == "CourseId")?.Value;
    }
    protected override async Task OnInitializedAsync()
    {
        var authState = await Auth.GetAuthenticationStateAsync();
        var user = authState.User;
        var isTeacher = user.IsInRole("Teacher");
        var isStudent = user.IsInRole("Student");
        if (isTeacher)
        {
            await HandleTeacher();
        }
        else if (isStudent)
        {
            HandleStudent(user);
        }
        else
        {
            await InvokeAsync(() => Navigation.NavigateTo("/account/login"));
        }
        
        MySchedule = await myApi.CallApiGetAsync<ScheduleDto>($"schedules/{CourseId}");

        
        // Add the course start as an event
        Events.Add(new ScheduleEvent
        {
            Start = MySchedule.StartDate,
            End = MySchedule.StartDate.AddHours(1), // Just a placeholder duration
            Text = $"Course: {MySchedule.Course.Name}"
        });

        // Add each module
        foreach (var module in MySchedule.Modules)
        {
            Events.Add(new ScheduleEvent
            {
                Start = module.StartDate,
                End = module.StartDate.AddHours(1), // Only start time matters, so short duration
                Text = $"Module: {module.Name}"
            });

            // Add each activity
            foreach (var activity in module.ModuleActivities)
            {
                Events.Add(new ScheduleEvent
                {
                    Start = activity.StartDate,
                    End = activity.StartDate.AddHours(1), // Single day, so just a short duration
                    Text = $"Activity: {activity.Name}"
                });
            }
        }
    }
}